import discord
from discord.ext import commands, tasks
import datetime
from zoneinfo import ZoneInfo
import json
import os

# ===== CONFIG =====
TOKEN = os.getenv("DISCORD_TOKEN")  # pulled from Render env var
GUILD_ID = 1430220748269682720      # your server ID
CHANNEL_ID = 1430221035151560774    # your #daily-muster channel ID
TZ = ZoneInfo("America/Los_Angeles")

# TEST SCHEDULE (for quick verification)
POST_TIME   = (10, 05)   # 1005 PST - post muster
REPORT_TIME = (10, 10)   # 1010 PST - post summary
RESET_TIME  = (10, 15)   # 1015 PST - reset & TORIS messagee

STATE_FILE = "muster_state.json"

intents = discord.Intents.default()
intents.members = True
intents.message_content = True
bot = commands.Bot(command_prefix="!", intents=intents)

# ===== Data Handling =====
def load_state():
    if os.path.exists(STATE_FILE):
        with open(STATE_FILE, "r") as f:
            return json.load(f)
    return {"mustered": [], "last_post": None, "last_post_date": None}

def save_state():
    with open(STATE_FILE, "w") as f:
        json.dump(state, f)

state = load_state()

@bot.event
async def on_ready():
    print(f"‚úÖ Logged in as {bot.user}")
    scheduler.start()

# ===== Main Scheduler =====
@tasks.loop(minutes=1)
async def scheduler():
    now = datetime.datetime.now(TZ)
    hm = (now.hour, now.minute)

    if hm == POST_TIME:
        await post_muster()
    elif hm == REPORT_TIME:
        await post_report()
    elif hm == RESET_TIME:
        await reset_and_toris()

# ===== Post the Daily Muster =====
async def post_muster():
    channel = bot.get_channel(CHANNEL_ID)
    today = datetime.datetime.now(TZ).strftime("%d %b %Y")

    msg = await channel.send(
        f"‚öì **Daily Muster ‚Äî {today}**\n"
        f"‚úÖ React below to mark yourself present.\n"
        f"üïî Muster window: **0940‚Äì0945 PST (Test Run)**"
    )
    await msg.add_reaction("‚úÖ")

    state["mustered"] = []
    state["last_post"] = msg.id
    state["last_post_date"] = today
    save_state()

    print(f"[{today}] Muster posted @ 0940 PST")

# ===== Post the Daily Report =====
async def post_report():
    guild = bot.get_guild(GUILD_ID)
    channel = bot.get_channel(CHANNEL_ID)
    today = datetime.datetime.now(TZ).strftime("%d %b %Y")

    all_members = [m for m in guild.members if not m.bot]
    mustered_ids = set(state["mustered"])

    mustered = [m.name for m in all_members if m.id in mustered_ids]
    missing = [m.name for m in all_members if m.id not in mustered_ids]

    report = (
        f"üìÖ **Daily Muster Report ‚Äî {today}**\n"
        f"‚úÖ **Mustered:** {', '.join(mustered) if mustered else 'None'}\n"
        f"‚ùå **Not Mustered:** {', '.join(missing) if missing else 'All accounted for!'}"
    )
    await channel.send(report)
    print(f"[{today}] Report posted @ 0942 PST")

# ===== Reset & TORIS Message =====
async def reset_and_toris():
    channel = bot.get_channel(CHANNEL_ID)
    today = datetime.datetime.now(TZ).strftime("%d %b %Y")

    await channel.send(
        f"üïò **{today} 0945 PST:** Late will be taking muster in TORIS the next day "
        f"or the next available days."
    )

    # Reset data
    state["mustered"] = []
    state["last_post"] = None
    save_state()

    print(f"[{today}] Reset complete @ 0945 PST")

# ===== Reaction Event =====
@bot.event
async def on_reaction_add(reaction, user):
    if user.bot:
        return
    if reaction.emoji == "‚úÖ" and reaction.message.id == state.get("last_post"):
        if user.id not in state["mustered"]:
            state["mustered"].append(user.id)
            save_state()
            print(f"{user.name} mustered ‚úÖ")

bot.run(TOKEN)
